<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ú†Øªâ€ŒØ¨Ø§Øª Ù‡ÙˆØ´Ù…Ù†Ø¯ ÙØ§Ø±Ø³ÛŒ</title>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Vazirmatn', sans-serif; background: #f0f2f5; margin: 0; padding: 0; height: 100vh; display: flex; }
        .sidebar {
            width: 280px;
            background: #202123;
            color: white;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #343536;
        }
        .sidebar-header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #343536;
        }
        .new-chat-btn {
            background: #343536;
            border: none;
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .new-chat-btn:hover { background: #404040; }
        .chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        .chat-item {
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 6px;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .chat-item:hover { background: #343536; }
        .chat-item.active { background: #404040; font-weight: 500; }
        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .header { padding: 20px; background: #343536; color: white; text-align: center; font-size: 18px; }
        .messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 18px; background: #343536; }
        .message { max-width: 75%; padding: 14px 20px; border-radius: 22px; line-height: 1.6; word-wrap: break-word; }
        .user { align-self: flex-end; background: #0084ff; color: white; border-bottom-right-radius: 6px; }
        .bot { align-self: flex-start; background: #444654; color: white; border-bottom-left-radius: 6px; }
        .message img { max-width: 100%; border-radius: 14px; margin-top: 10px; }
        .input-area { padding: 20px; background: #343536; display: flex; gap: 12px; align-items: center; }
        .file-btn { width: 48px; height: 48px; background: #444654; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 22px; }
        #file-input { display: none; }
        #user-input { flex: 1; padding: 14px 20px; background: #444654; color: white; border: none; border-radius: 30px; font-size: 16px; outline: none; }
        #send-btn { width: 48px; height: 48px; background: #0084ff; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 18px; }
        .preview-container { position: relative; max-width: 200px; display: none; }
        .preview-img { max-height: 120px; border-radius: 12px; }
        .remove-preview { position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; background: #ff4444; color: white; border: none; border-radius: 50%; cursor: pointer; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <button class="new-chat-btn" id="new-chat-btn">+ Ù…Ú©Ø§Ù„Ù…Ù‡ Ø¬Ø¯ÛŒØ¯</button>
        </div>
        <div class="chat-list" id="chat-list"></div>
    </div>

    <div class="main-chat">
        <div class="header" id="chat-title">Ú†Øªâ€ŒØ¨Ø§Øª Ù‡ÙˆØ´Ù…Ù†Ø¯ ÙØ§Ø±Ø³ÛŒ</div>
        <div id="messages" class="messages">
            <div class="message bot">Ø³Ù„Ø§Ù…! Ù…Ù† Ú†Øªâ€ŒØ¨Ø§Øª Ù‡ÙˆØ´Ù…Ù†Ø¯ ÙØ§Ø±Ø³ÛŒâ€ŒØ§Ù… ğŸ˜Š<br>Ù‡Ø± Ú†ÛŒ Ø¯ÙˆØ³Øª Ø¯Ø§Ø±ÛŒ Ø¨Ù†ÙˆÛŒØ³ ÛŒØ§ Ø¹Ú©Ø³ Ø¨ÙØ±Ø³Øª!</div>
        </div>
        <div class="input-area">
            <label for="file-input" class="file-btn">ğŸ“</label>
            <input type="file" id="file-input" accept="image/*">
            <input type="text" id="user-input" placeholder="Ù¾ÛŒØ§Ù… ÛŒØ§ Ø³Ø¤Ø§Ù„Øª Ø±Ùˆ Ø¨Ù†ÙˆÛŒØ³...">
            <button id="send-btn">â¤</button>
            <div id="preview-container" class="preview-container">
                <button id="remove-preview" class="remove-preview">âœ•</button>
                <img id="preview-img" class="preview-img">
            </div>
        </div>
    </div>

    <script>
        const messagesDiv = document.getElementById('messages');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const fileInput = document.getElementById('file-input');
        const previewContainer = document.getElementById('preview-container');
        const previewImg = document.getElementById('preview-img');
        const removeBtn = document.getElementById('remove-preview');
        const newChatBtn = document.getElementById('new-chat-btn');
        const chatList = document.getElementById('chat-list');
        const chatTitle = document.getElementById('chat-title');

        let isSending = false;

        let allChats = JSON.parse(localStorage.getItem('all_chats')) || [];

        let currentSessionId = sessionStorage.getItem('current_session_id');
        if (!currentSessionId) {
            currentSessionId = allChats.length > 0 ? allChats[allChats.length - 1].id : crypto.randomUUID();
            sessionStorage.setItem('current_session_id', currentSessionId);
        }

        if (!allChats.find(chat => chat.id === currentSessionId)) {
            allChats.push({ id: currentSessionId, title: "Ù…Ú©Ø§Ù„Ù…Ù‡ Ø¬Ø¯ÛŒØ¯" });
            localStorage.setItem('all_chats', JSON.stringify(allChats));
        }

        function scrollToBottom() {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        fileInput.addEventListener('change', () => {
            const file = fileInput.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = e => {
                    previewImg.src = e.target.result;
                    previewContainer.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                previewContainer.style.display = 'none';
            }
        });

        removeBtn.addEventListener('click', () => {
            fileInput.value = '';
            previewContainer.style.display = 'none';
        });

        function sendMessage() {
            if (isSending) return;

            const text = userInput.value.trim();
            const file = fileInput.files[0];

            if (!text && !file) return;

            isSending = true;
            sendBtn.disabled = true;

            const userMsg = document.createElement('div');
            userMsg.className = 'message user';
            if (text) userMsg.textContent = text;
            if (file) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                userMsg.appendChild(document.createElement('br'));
                userMsg.appendChild(img);
            }
            messagesDiv.appendChild(userMsg);
            scrollToBottom();

            const typing = document.createElement('div');
            typing.className = 'message bot';
            typing.textContent = 'Ø¯Ø± Ø­Ø§Ù„ ÙÚ©Ø± Ú©Ø±Ø¯Ù†...';
            messagesDiv.appendChild(typing);
            scrollToBottom();

            const formData = new FormData();
            if (text) formData.append('message', text);
            if (file) formData.append('file', file);

            fetch('/chat', {
                method: 'POST',
                headers: { 'X-Session-ID': currentSessionId },
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                messagesDiv.removeChild(typing);
                const botMsg = document.createElement('div');
                botMsg.className = 'message bot';
                botMsg.textContent = data.reply || 'Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯!';
                messagesDiv.appendChild(botMsg);
                scrollToBottom();
                updateChatTitle(data.reply);
            })
            .finally(() => {
                isSending = false;
                sendBtn.disabled = false;
                userInput.value = '';
                fileInput.value = '';
                previewContainer.style.display = 'none';
                userInput.focus();
            });
        }

        function updateChatTitle(lastMessage) {
            const chat = allChats.find(c => c.id === currentSessionId);
            if (chat) {
                let title = lastMessage.trim();
                if (title.length > 40) title = title.substring(0, 40) + "...";
                if (!title) title = "Ù…Ú©Ø§Ù„Ù…Ù‡ Ø¬Ø¯ÛŒØ¯";
                chat.title = title;
                localStorage.setItem('all_chats', JSON.stringify(allChats));
                loadChatList();
            }
        }

        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', e => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        async function loadChatList() {
            try {
                const res = await fetch('/chat_list');
                const chats = await res.json();
                allChats = chats; 
                localStorage.setItem('all_chats', JSON.stringify(allChats));
                chatList.innerHTML = '';
                chats.forEach(chat => {
                    const item = document.createElement('div');
                    item.className = 'chat-item';
                    if (chat.id === currentSessionId) item.classList.add('active');
                    item.textContent = chat.title;
                    item.onclick = () => switchChat(chat.id);
                    chatList.appendChild(item);
                });
            } catch (err) {
                console.log("Ø®Ø·Ø§ Ø¯Ø± Ù„ÙˆØ¯ Ù„ÛŒØ³Øª Ù…Ú©Ø§Ù„Ù…Ù‡â€ŒÙ‡Ø§");
            }
        }

        async function switchChat(sessionId) {
            currentSessionId = sessionId;
            sessionStorage.setItem('current_session_id', sessionId);
            await loadMessages();
            loadChatList();
        }

        async function loadMessages() {
            try {
                const res = await fetch(`/history?session_id=${currentSessionId}`);
                const history = await res.json();
                messagesDiv.innerHTML = '<div class="message bot">Ø³Ù„Ø§Ù…! Ù…Ù† Ú†Øªâ€ŒØ¨Ø§Øª Ù‡ÙˆØ´Ù…Ù†Ø¯ ÙØ§Ø±Ø³ÛŒâ€ŒØ§Ù… ğŸ˜Š<br>Ù‡Ø± Ú†ÛŒ Ø¯ÙˆØ³Øª Ø¯Ø§Ø±ÛŒ Ø¨Ù†ÙˆÛŒØ³ ÛŒØ§ Ø¹Ú©Ø³ Ø¨ÙØ±Ø³Øª!</div>';
                history.forEach(msg => {
                    const div = document.createElement('div');
                    div.className = `message ${msg.role}`;
                    if (msg.content) div.textContent = msg.content;
                    if (msg.image) {
                        const img = document.createElement('img');
                        img.src = msg.image;
                        div.appendChild(document.createElement('br'));
                        div.appendChild(img);
                    }
                    messagesDiv.appendChild(div);
                });
                scrollToBottom();
            } catch (err) {
                console.log("Ø®Ø·Ø§ Ø¯Ø± Ù„ÙˆØ¯ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§");
            }
        }

        newChatBtn.addEventListener('click', () => {
            currentSessionId = crypto.randomUUID();
            sessionStorage.setItem('current_session_id', currentSessionId);
            messagesDiv.innerHTML = '<div class="message bot">Ø³Ù„Ø§Ù…! Ù…Ù† Ú†Øªâ€ŒØ¨Ø§Øª Ù‡ÙˆØ´Ù…Ù†Ø¯ ÙØ§Ø±Ø³ÛŒâ€ŒØ§Ù… ğŸ˜Š<br>Ù‡Ø± Ú†ÛŒ Ø¯ÙˆØ³Øª Ø¯Ø§Ø±ÛŒ Ø¨Ù†ÙˆÛŒØ³ ÛŒØ§ Ø¹Ú©Ø³ Ø¨ÙØ±Ø³Øª!</div>';
            loadChatList();
            scrollToBottom();
        });

        window.onload = () => {
            loadMessages();
            loadChatList();
            scrollToBottom();
        };
    </script>
</body>
</html>