<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ú†Øªâ€ŒØ¨Ø§Øª Ù‡ÙˆØ´Ù…Ù†Ø¯ ÙØ§Ø±Ø³ÛŒ</title>
    <style>
        body { font-family: Tahoma, sans-serif; background: #f0f2f5; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; }
        .chat-container { flex: 1; max-width: 900px; margin: 20px auto; background: white; border-radius: 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.08); display: flex; flex-direction: column; overflow: hidden; }
        .messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 18px; }
        .message { max-width: 75%; padding: 14px 20px; border-radius: 22px; line-height: 1.6; word-wrap: break-word; position: relative; }
        .user { align-self: flex-end; background: #0084ff; color: white; border-bottom-right-radius: 6px; cursor: pointer; }
        .user:hover { background: #0066cc; }
        .bot { align-self: flex-start; background: #e9ecef; color: #333; border-bottom-left-radius: 6px; }
        .message img { max-width: 100%; border-radius: 14px; margin-top: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .edit-btn { position: absolute; top: 8px; left: 8px; font-size: 12px; background: rgba(255,255,255,0.3); padding: 4px 8px; border-radius: 10px; opacity: 0; transition: opacity 0.2s; }
        .user:hover .edit-btn { opacity: 1; }
        .input-area { padding: 14px 20px; border-top: 1px solid #ddd; background: white; display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .file-btn { width: 48px; height: 48px; background: #f1f3f5; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 22px; transition: all 0.2s; }
        .file-btn:hover { background: #e0e0e0; }
        #file-input { display: none; }
        #user-input { flex: 1; padding: 14px 20px; border: 1px solid #ccc; border-radius: 30px; font-size: 16px; outline: none; min-height: 48px; box-sizing: border-box; }
        #send-btn { width: 60px; height: 48px; background: #0084ff; color: white; border: none; border-radius: 30px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: all 0.3s; }
        #send-btn:hover:not(:disabled) { background: #0066cc; }
        #send-btn:disabled { background: #aaa; cursor: not-allowed; opacity: 0.6; }
        .preview-container { position: relative; margin-top: 8px; max-width: 200px; display: inline-block; }
        .preview-img { max-height: 120px; border-radius: 12px; border: 1px solid #ddd; display: block; }
        .file-name { font-size: 13px; color: #555; margin-top: 4px; text-align: center; }
        .remove-preview { position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; background: #ff4444; color: white; border: none; border-radius: 50%; font-size: 14px; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
        .remove-preview:hover { background: #cc0000; }
        .typing { font-style: italic; color: #666; align-self: flex-start; background: #e9ecef; padding: 14px 20px; border-radius: 22px; border-bottom-left-radius: 6px; }
    </style>
</head>
<body>
    <div class="chat-container">
        <div id="messages" class="messages">
            <div class="message bot">Ø³Ù„Ø§Ù…! Ù…Ù† Ú†Øªâ€ŒØ¨Ø§Øª Ù‡ÙˆØ´Ù…Ù†Ø¯ ÙØ§Ø±Ø³ÛŒâ€ŒØ§Ù… ğŸ˜Š<br>Ù‡Ø± Ú†ÛŒ Ø¯ÙˆØ³Øª Ø¯Ø§Ø±ÛŒ Ø¨Ù†ÙˆÛŒØ³ ÛŒØ§ Ø¹Ú©Ø³ Ø¨ÙØ±Ø³ØªØŒ Ù‡Ù…Ù‡ Ø±Ùˆ Ù…ÛŒâ€ŒÙÙ‡Ù…Ù…!</div>
        </div>

        <div class="input-area">
            <label for="file-input" class="file-btn" title="Ø¹Ú©Ø³ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†">ğŸ“</label>
            <input type="file" id="file-input" accept="image/*">

            <input type="text" id="user-input" placeholder="Ù¾ÛŒØ§Ù… ÛŒØ§ Ø³Ø¤Ø§Ù„Øª Ø±Ùˆ Ø¨Ù†ÙˆÛŒØ³..." autocomplete="off">

            <button id="send-btn" title="Ø§Ø±Ø³Ø§Ù„">â¤</button>

            <div id="preview-container" class="preview-container" style="display:none;">
                <button id="remove-preview" class="remove-preview" title="Ø­Ø°Ù Ø¹Ú©Ø³">âœ•</button>
                <img id="preview-img" class="preview-img">
                <div id="file-name" class="file-name"></div>
            </div>
        </div>
    </div>

    <script>
        const messagesDiv = document.getElementById('messages');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const fileInput = document.getElementById('file-input');
        const previewContainer = document.getElementById('preview-container');
        const previewImg = document.getElementById('preview-img');
        const fileNameDiv = document.getElementById('file-name');
        const removeBtn = document.getElementById('remove-preview');

        let isSending = false;

        function scrollToBottom() {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        window.onload = scrollToBottom;

        removeBtn.addEventListener('click', () => {
            fileInput.value = '';
            previewContainer.style.display = 'none';
            fileNameDiv.textContent = '';
        });

        fileInput.addEventListener('change', () => {
            const file = fileInput.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImg.src = e.target.result;
                    previewContainer.style.display = 'inline-block';
                    fileNameDiv.textContent = file.name;
                };
                reader.readAsDataURL(file);
            } else {
                previewContainer.style.display = 'none';
                fileNameDiv.textContent = '';
            }
        });

        function makeEditable(messageDiv) {
            messageDiv.addEventListener('click', () => {
                if (isSending) return;

                const currentText = messageDiv.textContent.trim();
                const images = messageDiv.querySelectorAll('img');
                const hasImage = images.length > 0;

                const textarea = document.createElement('textarea');
                textarea.value = currentText;
                textarea.style.width = '100%';
                textarea.style.minHeight = '60px';
                textarea.style.padding = '10px';
                textarea.style.borderRadius = '12px';
                textarea.style.border = '1px solid #ccc';
                textarea.style.fontSize = '16px';

                messageDiv.innerHTML = '';
                messageDiv.appendChild(textarea);

                if (hasImage) {
                    images.forEach(img => messageDiv.appendChild(img.cloneNode()));
                }

                textarea.focus();

                const saveEdit = () => {
                    const newText = textarea.value.trim();
                    messageDiv.innerHTML = newText || 'Ù¾ÛŒØ§Ù… ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯Ù‡';
                    if (hasImage) {
                        images.forEach(img => {
                            messageDiv.appendChild(document.createElement('br'));
                            messageDiv.appendChild(img.cloneNode());
                        });
                    }
                    makeEditable(messageDiv);
                };

                textarea.addEventListener('blur', saveEdit);
                textarea.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        saveEdit();
                    }
                });
            });
        }

        function sendMessage() {
            if (isSending) return;

            const text = userInput.value.trim();
            const file = fileInput.files[0];

            if (!text && !file) return;

            isSending = true;
            sendBtn.disabled = true;

            const userMsg = document.createElement('div');
            userMsg.className = 'message user';
            if (text) userMsg.textContent = text;
            if (file && file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                userMsg.appendChild(document.createElement('br'));
                userMsg.appendChild(img);
            }
            messagesDiv.appendChild(userMsg);
            makeEditable(userMsg);
            scrollToBottom();

            const typingMsg = document.createElement('div');
            typingMsg.className = 'message bot typing';
            typingMsg.textContent = 'Ø¯Ø± Ø­Ø§Ù„ ÙÚ©Ø± Ú©Ø±Ø¯Ù†...';
            messagesDiv.appendChild(typingMsg);
            scrollToBottom();

            const formData = new FormData();
            if (text) formData.append('message', text);
            if (file) formData.append('file', file);

            userInput.value = '';
            fileInput.value = '';
            previewContainer.style.display = 'none';
            fileNameDiv.textContent = '';

            fetch('/chat', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                messagesDiv.removeChild(typingMsg);
                const botMsg = document.createElement('div');
                botMsg.className = 'message bot';
                botMsg.textContent = data.reply || data.error || 'Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯!';
                if (data.error) botMsg.style.background = '#ff4444';
                messagesDiv.appendChild(botMsg);
                scrollToBottom();
            })
            .catch(() => {
                messagesDiv.removeChild(typingMsg);
                const errMsg = document.createElement('div');
                errMsg.className = 'message bot';
                errMsg.textContent = 'Ù…Ø´Ú©Ù„ Ø§Ø±ØªØ¨Ø§Ø·ÛŒ Ù¾ÛŒØ´ Ø§ÙˆÙ…Ø¯...';
                errMsg.style.background = '#ff4444';
                messagesDiv.appendChild(errMsg);
                scrollToBottom();
            })
            .finally(() => {
                isSending = false;
                sendBtn.disabled = false;
            });
        }

        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
</body>
</html>